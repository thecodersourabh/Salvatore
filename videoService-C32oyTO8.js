import{t as S}from"./index-DUvvqMAG.js";import"./ui-CYoahuZR.js";import"./vendor-B_deTkiR.js";import"./router-Cn4Sc231.js";import"./dashboard-DNoTp1yc.js";const m="https://spg85rhps6.execute-api.us-east-1.amazonaws.com/prod";class p{static async initMultipartUpload(s,c,i=8*1024*1024){const l=`${m.replace(/\/$/,"")}/upload/multipart/init`;try{console.debug("[VideoService] initMultipartUpload (direct fetch) ->",{apiBase:m,url:l,payload:{key:s,contentType:c,partSize:i}});const o=S(),e={"Content-Type":"application/json"};o&&(e.Authorization=`Bearer ${o}`);const r=localStorage.getItem("x-user-id");r&&(e["x-user-id"]=r);const a=await fetch(l,{method:"POST",headers:e,body:JSON.stringify({key:s,contentType:c,partSize:i})}),n=await a.text();let t=null;try{t=n?JSON.parse(n):null}catch{t=n}if(!a.ok)throw console.debug("[VideoService] initMultipartUpload response not ok ->",a.status,t),new Error((t==null?void 0:t.message)||`Init multipart failed: ${a.status}`);return console.debug("[VideoService] initMultipartUpload response ->",t),t}catch(o){throw console.error("[VideoService] initMultipartUpload failed",o),o}}static async getPartPresignedUrl(s,c,i){const l=`${m.replace(/\/$/,"")}/upload/multipart/part`;try{console.debug("[VideoService] getPartPresignedUrl (direct fetch) ->",{url:l,payload:{key:s,uploadId:c,partNumber:i}});const o=S(),e={"Content-Type":"application/json"};o&&(e.Authorization=`Bearer ${o}`);const r=localStorage.getItem("x-user-id");r&&(e["x-user-id"]=r);const a=await fetch(l,{method:"POST",headers:e,body:JSON.stringify({key:s,uploadId:c,partNumber:i})}),n=await a.text();let t=null;try{t=n?JSON.parse(n):null}catch{t=n}if(!a.ok)throw console.debug("[VideoService] getPartPresignedUrl response not ok ->",a.status,t),new Error((t==null?void 0:t.message)||`Get part presigned URL failed: ${a.status}`);return console.debug("[VideoService] getPartPresignedUrl response ->",t),t}catch(o){throw console.error("[VideoService] getPartPresignedUrl failed",o),o}}static async completeMultipartUpload(s,c,i){const l=`${m.replace(/\/$/,"")}/upload/multipart/complete`;try{console.debug("[VideoService] completeMultipartUpload (direct fetch) ->",{url:l,payload:{key:s,uploadId:c,parts:i}});const o=S(),e={"Content-Type":"application/json"};o&&(e.Authorization=`Bearer ${o}`);const r=localStorage.getItem("x-user-id");r&&(e["x-user-id"]=r);const a=await fetch(l,{method:"POST",headers:e,body:JSON.stringify({key:s,uploadId:c,parts:i})}),n=await a.text();let t=null;try{t=n?JSON.parse(n):null}catch{t=n}if(!a.ok)throw console.debug("[VideoService] completeMultipartUpload response not ok ->",a.status,t),new Error((t==null?void 0:t.message)||`Complete multipart failed: ${a.status}`);return console.debug("[VideoService] completeMultipartUpload response ->",t),t}catch(o){throw console.error("[VideoService] completeMultipartUpload failed",o),o}}static uploadPart(s,c,i){return new Promise((l,o)=>{try{const e=new XMLHttpRequest;e.open("PUT",s,!0),e.upload.onprogress=r=>{r.lengthComputable&&i&&i(r.loaded)},e.onload=()=>{if(e.status>=200&&e.status<300){const r=e.getResponseHeader("ETag")||e.getResponseHeader("etag")||"";l({ETag:r.replace(/"/g,"")})}else console.error("[VideoService] Part upload failed:",{status:e.status,statusText:e.statusText,response:e.responseText}),o(new Error(`Part upload failed with status ${e.status}: ${e.statusText}`))},e.onerror=()=>o(new Error("Network error during part upload")),e.send(c)}catch(e){o(e)}})}static async uploadMultipart(s,c,i,l=8*1024*1024){if(s.size>20971520)throw new Error(`Video file too large. Maximum size is 20 MB, but file is ${Math.round(s.size/(1024*1024))} MB`);console.debug("[VideoService] uploadMultipart start",{key:c,size:s.size,partSize:l});const e=await p.initMultipartUpload(c,s.type,l);if(console.debug("[VideoService] init response:",e),!e.uploadId)throw new Error("Multipart init did not return uploadId. Response: "+JSON.stringify(e));const r=s.size,a=Math.ceil(r/l);console.debug("[VideoService] calculated total parts:",a);let n=0;const t=[],g=async u=>{const d=u+1,h=u*l,f=Math.min(h+l,r),y=s.slice(h,f);console.debug(`[VideoService] uploading part ${d}/${a}`,{start:h,end:f,size:y.size});const x=await p.getPartPresignedUrl(e.key,e.uploadId,d);let w=0;const b=await p.uploadPart(x.url,y,P=>{const U=P-w;w=P,n+=U,i&&i(Math.round(n/r*100))}),M=f-h-w;return M>0&&(n+=M,i&&i(Math.round(n/r*100))),console.debug(`[VideoService] completed part ${d}`,{ETag:b.ETag}),{ETag:b.ETag,PartNumber:d}};console.debug("[VideoService] starting sequential part uploads");for(let u=0;u<a;u++)try{const d=await g(u);t.push(d)}catch(d){throw console.error(`[VideoService] failed to upload part ${u+1}:`,d),new Error(`Failed to upload part ${u+1}: ${d}`)}if(t&&t.length>0)t.sort((u,d)=>u.PartNumber-d.PartNumber),console.debug("[VideoService] sorted parts for completion:",t);else throw new Error("No parts were successfully uploaded");return console.debug("[VideoService] completing multipart upload"),await p.completeMultipartUpload(e.key,e.uploadId,t),e.key}}export{p as VideoService,p as default};
